(window.webpackJsonp=window.webpackJsonp||[]).push([[91],{"4f8Z":function(e,t,i){"use strict";i.d(t,"a",(function(){return s})),i.d(t,"b",(function(){return n})),i.d(t,"c",(function(){return r}));i("rB9j"),i("UxlC"),i("TWNs");var s=function(e){return TPS.pageData.deliveryCountryList.concat(TPS.pageData.billingCountryList).find((function(t){return t.isocode===e}))},n=function(e){return TPS.pageData.titlesList.find((function(t){return t.code===e}))},r=function(e){return e.replace(new RegExp(/["<>/()]/,"g"),"")}},"T+Th":function(e,t,i){"use strict";i.d(t,"c",(function(){return s})),i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return r})),i.d(t,"d",(function(){return o}));var s=function(e,t,i){if(t>i){var s=[i,t];t=s[0],i=s[1]}return e>=t&&e<=i},n={1:"Mon",2:"Tue",3:"Wed",4:"Thu",5:"Fri",6:"Sat",7:"Sun"},r={Mon:1,Tue:2,Wed:3,Thu:4,Fri:5,Sat:6,Sun:7},o=function(e){return e||(e=new Date),e instanceof Date&&(e=e.getDay()),0===e&&(e+=7),e}},mH21:function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));i("rB9j"),i("ToJy");var s=i("g2sj"),n=i("T+Th"),r=s.a.makePrettyDateValue,o=Backbone.Model.extend({defaults:{closing:!1,time:"00:00",day:"Mon",date:new Date},parse:function(e){return e.date?{closing:e.closing,date:e.date,day:n.a[Object(n.d)(e.date.getDay())],time:"".concat(r(e.date.getHours()),":").concat(r(e.date.getMinutes()))}:{}},getTime:function(){return(this.get("date")instanceof Date?this.get("date"):new Date).getTime()}}),a=Backbone.Model.extend({defaults:{closed:!1,day:Object(n.d)((new Date).getDay()),weekDay:n.a[Object(n.d)((new Date).getDay())],opening:new o,closing:new o},parseEvent:function(e,t,i){if(e&&"string"==typeof e.formattedHour){var s=new Date,r=e.formattedHour.split(":");s.setHours(r[0],r[1],0);var a=n.b[t],l=Object(n.d)(),u=s.getDate()+(a<l?7:0)-l+a;return s.setDate(u),new o({date:s,closing:i},{parse:!0})}return null},getFirstEvent:function(){return[new Date,this.get("opening"),this.get("closing")].sort((function(e,t){return e.getTime()-t.getTime()})).find((function(e,t,i){return t>i.findIndex((function(e){return e instanceof Date}))}))},parse:function(e){return{closed:e.closed||e.openingTime&&null===e.openingTime.formattedHour||e.closingTime&&null===e.closingTime.formattedHour,day:n.b[e.weekDay],weekDay:e.weekDay,opening:this.parseEvent(e.openingTime,e.weekDay,!1),closing:this.parseEvent(e.closingTime,e.weekDay,!0)}}}),l=Backbone.Collection.extend({model:a,comparator:"day",idAttribute:"day",isOpenedNow:function(){var e=this.getNextEvent();return Boolean(!this.at(Object(n.d)()-1).get("closed")&&(null==e?void 0:e.get("closing")))},getNextEvent:function(){return this.filter((function(e){return null!==e&&!e.get("closed")})).sort((function(e,t){var i=e.get("day"),s=t.get("day");return i<Object(n.d)()&&(i+=7),s<Object(n.d)()&&(s+=7),i-s})).map((function(e){return e.getFirstEvent()})).filter((function(e){return Boolean(e)}))[0]}})},xfcM:function(e,t,i){"use strict";i.r(t),i.d(t,"default",(function(){return R}));i("FZtP");var s=i("Xapy"),n=i("B3fA"),r=i("mH21"),o=Backbone.Model.extend({idAttribute:"code",defaults:{active:!1,visible:!1,address:{},geoPoint:{latitude:"",longitude:""},name:"",description:"",closed:!1,code:"",url:"",formattedDistance:"",schedule:new r.a,additionalInfo:"",featureList:[],storeType:"",popular:!1,popularity:0,isOpenedNow:!1,timeUntil:new Date},parse:function(e){var t,i=new r.a(null==e||null===(t=e.openingHours)||void 0===t?void 0:t.weekDayOpeningList,{parse:!0}),s=i.getNextEvent();return _.extend({},e,{schedule:i,nextEvent:s,url:TPS.utils.getInternationalUrl(e.url)})}}),a=Backbone.Collection.extend({model:o}),l=Backbone.Model.extend({defaults:{lat:NaN,lng:NaN,north:NaN,south:NaN,east:NaN,west:NaN,stores:new a},parse:function(e){return{lat:e.sourceLatitude,lng:e.sourceLongitude,north:e.boundNorthLatitude,south:e.boundSouthLatitude,east:e.boundEastLongitude,west:e.boundWestLongitude,stores:new a(e.results,{parse:!0})}}}),u=i("4f8Z"),h=i("T+Th"),c=new(Backbone.Model.extend({defaults:{loading:!1,error:"",query:"",results:new l,cache:{},allStores:TPS.pageData.allStores,popularStores:TPS.pageData.mostPopularStores,isPopular:!0,useLocation:!1,userLocation:{}},initialize:function(){var e=this;this.preparePopularStores(),this.listenTo(this,"change:query",this.fetchStores),this.listenTo(this,"change:useLocation",this.listenToUserLocation),this.listenTo(this,"select-store",this.setActive),setTimeout((function(){e.resetStores()}))},preparePopularStores:function(){var e=this,t=this.get("allStores").map((function(t){var i=e.get("popularStores").findIndex((function(e){return e.code===t.code}))+1;return _.extend(t,{popular:Boolean(i),popularity:i})})),i={south:TPS.utils.isGreatBritain()?52.02577417733089:52.3313175907249,west:TPS.utils.isGreatBritain()?-8.471923828125:-11.745259542935742,north:TPS.utils.isGreatBritain()?55.8755985527665:54.287040283275395,east:TPS.utils.isGreatBritain()?3.447998046875:-5.285298605435742},s=new l({sourceLatitude:(i.north-i.south)/2+i.south,sourceLongitude:(i.east-i.west)/2+i.west,boundNorthLatitude:i.north,boundSouthLatitude:i.south,boundEastLongitude:i.east,boundWestLongitude:i.west,results:t},{parse:!0});this.set({popularStores:s})},setActive:function(e,t){this.get("results").get("stores").forEach((function(i){i.set("active",e.get("code")===i.get("code")&&(t||!i.get("active")))}))},unsetActive:function(){this.get("results").get("stores").filter((function(e){return e.get("active")})).forEach((function(e){return e.set({active:!1},{silent:!0})}))},setError:function(e,t){this.set({error:e}),t&&this.resetStores()},resetStores:function(){this.unsetActive(),this.set({results:this.get("popularStores"),isPopular:!0})},getStores:function(e){this.setError(""),"string"==typeof e&&(e=Object(u.c)(e)),this.set({query:e},{silent:!0}),this.set("useLocation",!1),this.trigger("change:query")},fetchStores:function(){this.set("loading",!0);var e=this.get("query"),t=this.get("cache");"string"==typeof e&&t.hasOwnProperty(e.toLowerCase())?(this.unsetActive(),this.set({results:t[e.toLowerCase()],isPopular:!1,loading:!1})):e.hasOwnProperty("bounds")?this.findStoresLocally(e):this.loadStoresFromServer()},searchByPostCode:function(e){return $.csrfAjax(s.c.GET_STORES_ADDRESSES,{q:e})},searchByCoordinates:function(e){var t=e.latitude,i=e.longitude;return $.csrfAjax(s.c.GET_STORES_ADDRESSES,{latitude:t,longitude:i})},findStoresLocally:function(e){var t=e.bounds,i=this.get("allStores").filter((function(e){return Object(h.c)(e.geoPoint.longitude,t.west,t.east)&&Object(h.c)(e.geoPoint.latitude,t.south,t.north)}));i.length?this.saveResult({sourceLatitude:(t.north-t.south)/2+t.south,sourceLongitude:(t.east-t.west)/2+t.west,boundNorthLatitude:t.north,boundSouthLatitude:t.south,boundEastLongitude:t.east,boundWestLongitude:t.west,results:i}):this.setError(TPS.messages["redesign.store.finder.search.error.no.result"])},loadStoresFromServer:function(){var e=this;("string"==typeof this.get("query")?this.searchByPostCode:this.searchByCoordinates)(this.get("query")).done((function(t){t?"string"==typeof t?e.setError(TPS.messages["redesign.store.finder.search.error.invalid.query"],!0):t.errorCode?e.setError(t.message,!0):t.results.length>0?e.saveResult(t):e.setError(TPS.messages["redesign.store.finder.search.error.no.result"],!0):e.setError(TPS.messages["redesign.store.finder.search.error.invalid.query"],!0)})).fail((function(t){403===t.status&&window.location.reload();var i=t.statusText||"Something Went Wrong";e.setError(i,!0)})).always((function(){return e.set("loading",!1)}))},saveResult:function(e){this.unsetActive(),this.set({results:new l(e,{parse:!0}),isPopular:!1}),this.saveToCache(this.get("query"),this.get("results"))},saveToCache:function(e,t){"string"==typeof e&&(this.get("cache")[e.toLowerCase()]=t)},listenToUserLocation:function(){var e=this;this.get("useLocation")?this.locationWatcher=navigator.geolocation.watchPosition((function(t){var i=t.coords;e.attributes.userLocation=i,e.trigger("change:userLocation",i)}),$.noop,{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}):navigator.geolocation.clearWatch(this.locationWatcher)}}));n.a.add("StoreFinder",c);i("rB9j"),i("ToJy"),i("vxnP"),i("MdDL");var d=i("qmvR"),g=i("WQFK"),p="\n    <div class=\"store_item__label\">\n        <div class=\"store_item__label_pin {{=storeType === 'SUPERDRUG'\n            ? 'store_item__label_pin-superdrug' : ''}}\">\n            {{=(formattedDistance) ? index : '' }}\n        </div>\n        <div class=\"store_item__label_info\">\n            <h4>{{=name}}</h4>\n            <p class=\"Store_location\">{{=address.streetName}}, {{=address.postalcode}}</p>\n            <b class=\"store_item__label_name-hours\">\n                {{ if (nextEvent) { }}\n                    {{=TPS.messages['redesign.store.details.schedule.' + (nextEvent.get('closing') ? 'open' : 'closed.now')]}}\n                    {{=TPS.messages['redesign.store.details.schedule.until']}}\n                    {{=nextEvent.get('time')}}\n                    {{ if ((nextEvent.get('date') - new Date()) > 24 * 60 * 60 * 1000) { }}\n                        {{=nextEvent.get('day')}}\n                    {{ } }}\n                {{ } else { }}\n                    {{=TPS.messages['redesign.store.details.schedule.closed']}}\n                {{ } }}\n            </b>\n            {{ if (formattedDistance) { }}\n                <p class=\"store_item__label_distance\">({{=formattedDistance}})</p>\n            {{ } }}\n        </div>\n        <div class=\"store_item__label_additional {{=formattedDistance ? '' : 'store_item__label_additional-no_distance'}}\">\n            {{ if (formattedDistance) { }}\n                <span class=\"store_item__label_additional-distance\">({{=formattedDistance}})</span>\n            {{ } }}\n            <span class=\"icon icon_arrow-right j-show_details\"></span>\n        </div>\n    </div>\n    <div class=\"store_item__info\">\n        <h4>{{=TPS.messages['redesign.store.details.schedule.our.opening.hours']}}</h4>\n        <table class=\"store_schedule\">\n            {{ schedule.forEach(function (day, i) { }}\n                <tr class=\"store_schedule__day {{=currentDay === (i + 1) ? 'today' : ''}}\">\n                    <td>{{=day.get('weekDay')}}</td>\n                    <td>\n                        {{ if (day.get('closed')) { }}\n                            {{=TPS.messages['redesign.store.details.schedule.closed']}}\n                        {{ } else { }}\n                            {{=day.get('opening').get('time')}} - {{=day.get('closing').get('time')}}\n                        {{ } }}\n                    </td>\n                </tr>\n            {{ }) }}\n        </table>\n        {{ if (address.phone) { }}\n            <p class=\"hide-mobile\">{{=TPS.messages['redesign.store.details.address.tel']}} {{=address.phone}}</p>\n        {{ } }}\n        {{ if (featureList) { }}\n            <div class=\"store_item__info_services\">\n                {{ for (let i = 0; i < featureList.length; i++) { }}\n                    <span class=\"icon icon_service {{=featureList[i].storeFeatureCode}}\"\n                        aria-label=\"{{=featureList[i].storeFeatureName}}\" title=\"{{=featureList[i].storeFeatureName}}\">\n                    </span>\n                {{ } }}\n            </div>\n        {{ } }}\n        <div class=\"store_item__info_buttons\">\n            {{ if (address.phone) { }}\n                <a class=\"btn btn-black store_item__info_call\" href=\"tel:{{=address.phone.replace(/D/g, '')}}\">\n                    {{=TPS.messages['redesign.store.details.call.store']}}\n                </a>\n            {{ } }}\n            <a class=\"btn btn-black store_item__info_direction\"\n                href=\"".concat(d.c?"https://maps.apple.com/?daddr=":"https://maps.google.com/?daddr=",'{{=geoPoint.latitude}},{{=geoPoint.longitude}}">\n                {{=TPS.messages[\'redesign.store.details.direction.store\']}}\n            </a>\n        </div>\n        <p></p>\n        <a class="To_Store_page store_item__info_details" href="{{=url}}">{{=TPS.messages[\'redesign.store.details.more.details\']}}</a>\n    </div>\n'),f=Backbone.View.extend({tagName:"li",className:"store_item",template:_.template(p),initialize:function(e){this.listenTo(this.model,"change:active",this.toggleView)},render:function(){return this.$el.html(this.template(_.extend({},this.model.toJSON(),{index:this.model.collection.indexOf(this.model)+1,currentDay:Object(h.d)()}))),this.$el.toggleClass("store_item-active",!1),this.delegateEvents(),this.bindTouchStartListener(),this},events:{"click .store_item__label":"setActive"},setActive:function(){n.a.get("StoreFinder").trigger("select-store",this.model)},toggleView:function(){var e=this;this.model.get("active")?this.$(".store_item__info").show(200,(function(){if("scrollBehavior"in document.documentElement.style)e.el.scrollIntoView({block:"nearest",behavior:"smooth"});else{var t=e.$el.closest(".j-store_finder__results"),i=t.height(),s=e.$el.height(),n=t.get(0).scrollTop,r=e.el.offsetTop,o=Math.abs(n-r)<Math.abs(n+i-(r+s))?r:r+s-i;t.get(0).scrollTop=o}})):this.$(".store_item__info").hide(),this.$el.toggleClass("store_item-active",this.model.get("active"))},toggleTooltip:function(e){var t=$(e.currentTarget);t.tooltip({collision:"flip",content:t.attr("title"),position:{my:"center bottom-15",at:"center top",using:function(e,t){$(this).css(e),$("<div>").addClass("arrow").addClass(t.vertical).addClass(t.horizontal).appendTo(this)}}})},bindTouchStartListener:function(){var e=this;this.$(".icon_service").each((function(t,i){i.addEventListener("touchstart",e.toggleTooltip,g.a)}))}}),m=Backbone.View.extend({initialize:function(e){this.listenTo(n.a.get("StoreFinder"),"change:results",this.renderList)},render:function(){return this.renderList(),this},renderList:function(){var e=this;this.$el.empty(),this.$el.parent().get(0).scrollTop=0,n.a.get("StoreFinder").get("results").get("stores").filter((function(e){return!n.a.get("StoreFinder").get("isPopular")||e.get("popular")})).sort((function(e,t){return e.get("popularity")-t.get("popularity")})).forEach((function(t){return e.renderStore(t)}))},renderStore:function(e){e.view||(e.view=new f({model:e})),this.$el.append(e.view.render().$el)}});i("4Brf"),i("4mDm"),i("3bBZ");function v(e){return(v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function y(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function k(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function S(e,t,i){return t&&k(e.prototype,t),i&&k(e,i),e}var T=function(){function e(t,i,s){y(this,e),this.extend(e,google.maps.OverlayView),this.map_=t,this.MARKER_CLUSTER_IMAGE_PATH_="../images/m",this.MARKER_CLUSTER_IMAGE_EXTENSION_="png",this.markers_=[],this.clusters_=[],this.sizes=[53,56,66,78,90],this.styles_=[],this.ready_=!1;var n=s||{};this.zIndex_=n.zIndex||google.maps.Marker.MAX_ZINDEX+1,this.gridSize_=n.gridSize||60,this.minClusterSize_=n.minimumClusterSize||2,this.maxZoom_=n.maxZoom||null,this.styles_=n.styles||[],this.imagePath_=n.imagePath||this.MARKER_CLUSTER_IMAGE_PATH_,this.imageExtension_=n.imageExtension||this.MARKER_CLUSTER_IMAGE_EXTENSION_,this.zoomOnClick_=!0,null!=n.zoomOnClick&&(this.zoomOnClick_=n.zoomOnClick),this.averageCenter_=!1,null!=n.averageCenter&&(this.averageCenter_=n.averageCenter),this.setupStyles_(),this.setMap(t),this.prevZoom_=this.map_.getZoom();var r=this;google.maps.event.addListener(this.map_,"zoom_changed",(function(){var e=r.map_.getZoom(),t=r.map_.minZoom||0,i=Math.min(r.map_.maxZoom||100,r.map_.mapTypes[r.map_.getMapTypeId()].maxZoom);e=Math.min(Math.max(e,t),i),r.prevZoom_!=e&&(r.prevZoom_=e,r.resetViewport())})),google.maps.event.addListener(this.map_,"idle",(function(){r.redraw()})),i&&(i.length||Object.keys(i).length)&&this.addMarkers(i,!1)}return S(e,[{key:"extend",value:function(e,t){return function(e){for(var t in e.prototype)this.prototype[t]=e.prototype[t];return this}.apply(e,[t])}},{key:"onAdd",value:function(){this.setReady_(!0)}},{key:"draw",value:function(){}},{key:"setupStyles_",value:function(){if(!this.styles_.length)for(var e,t=0;e=this.sizes[t];t++)this.styles_.push({url:this.imagePath_+(t+1)+"."+this.imageExtension_,height:e,width:e})}},{key:"fitMapToMarkers",value:function(){for(var e,t=this.getMarkers(),i=new google.maps.LatLngBounds,s=0;e=t[s];s++)i.extend(e.getPosition());this.map_.fitBounds(i)}},{key:"setZIndex",value:function(e){this.zIndex_=e}},{key:"getZIndex",value:function(){return this.zIndex_}},{key:"setStyles",value:function(e){this.styles_=e}},{key:"getStyles",value:function(){return this.styles_}},{key:"isZoomOnClick",value:function(){return this.zoomOnClick_}},{key:"isAverageCenter",value:function(){return this.averageCenter_}},{key:"getMarkers",value:function(){return this.markers_}},{key:"getTotalMarkers",value:function(){return this.markers_.length}},{key:"setMaxZoom",value:function(e){this.maxZoom_=e}},{key:"getMaxZoom",value:function(){return this.maxZoom_}},{key:"calculator_",value:function(e,t){for(var i=0,s=e.length,n=s;0!==n;)n=parseInt(n/10,10),i++;return{text:s,index:i=Math.min(i,t)}}},{key:"setCalculator",value:function(e){this.calculator_=e}},{key:"getCalculator",value:function(){return this.calculator_}},{key:"addMarkers",value:function(e,t){if(e.length)for(var i,s=0;i=e[s];s++)this.pushMarkerTo_(i);else if(Object.keys(e).length)for(var n in e)this.pushMarkerTo_(e[n]);t||this.redraw()}},{key:"pushMarkerTo_",value:function(e){if(e.isAdded=!1,e.draggable){var t=this;google.maps.event.addListener(e,"dragend",(function(){e.isAdded=!1,t.repaint()}))}this.markers_.push(e)}},{key:"addMarker",value:function(e,t){this.pushMarkerTo_(e),t||this.redraw()}},{key:"removeMarker_",value:function(e){var t=-1;if(this.markers_.indexOf)t=this.markers_.indexOf(e);else for(var i,s=0;i=this.markers_[s];s++)if(i==e){t=s;break}return-1!=t&&(e.setMap(null),this.markers_.splice(t,1),!0)}},{key:"removeMarker",value:function(e,t){var i=this.removeMarker_(e);return!(t||!i)&&(this.resetViewport(),this.redraw(),!0)}},{key:"removeMarkers",value:function(e,t){for(var i,s=e===this.getMarkers()?e.slice():e,n=!1,r=0;i=s[r];r++){var o=this.removeMarker_(i);n=n||o}if(!t&&n)return this.resetViewport(),this.redraw(),!0}},{key:"setReady_",value:function(e){this.ready_||(this.ready_=e,this.createClusters_())}},{key:"getTotalClusters",value:function(){return this.clusters_.length}},{key:"getMap",value:function(){return this.map_}},{key:"setMap",value:function(e){this.map_=e}},{key:"getGridSize",value:function(){return this.gridSize_}},{key:"setGridSize",value:function(e){this.gridSize_=e}},{key:"getMinClusterSize",value:function(){return this.minClusterSize_}},{key:"setMinClusterSize",value:function(e){this.minClusterSize_=e}},{key:"getExtendedBounds",value:function(e){var t=this.getProjection(),i=new google.maps.LatLng(e.getNorthEast().lat(),e.getNorthEast().lng()),s=new google.maps.LatLng(e.getSouthWest().lat(),e.getSouthWest().lng()),n=t.fromLatLngToDivPixel(i);n.x+=this.gridSize_,n.y-=this.gridSize_;var r=t.fromLatLngToDivPixel(s);r.x-=this.gridSize_,r.y+=this.gridSize_;var o=t.fromDivPixelToLatLng(n),a=t.fromDivPixelToLatLng(r);return e.extend(o),e.extend(a),e}},{key:"isMarkerInBounds_",value:function(e,t){return t.contains(e.getPosition())}},{key:"clearMarkers",value:function(){this.resetViewport(!0),this.markers_=[]}},{key:"resetViewport",value:function(e){for(var t,i=0;t=this.clusters_[i];i++)t.remove();for(var s,n=0;s=this.markers_[n];n++)s.isAdded=!1,e&&s.setMap(null);this.clusters_=[]}},{key:"repaint",value:function(){var e=this.clusters_.slice();this.clusters_.length=0,this.resetViewport(),this.redraw(),setTimeout((function(){for(var t,i=0;t=e[i];i++)t.remove()}),0)}},{key:"redraw",value:function(){this.createClusters_()}},{key:"distanceBetweenPoints_",value:function(e,t){if(!e||!t)return 0;var i=(t.lat()-e.lat())*Math.PI/180,s=(t.lng()-e.lng())*Math.PI/180,n=Math.sin(i/2)*Math.sin(i/2)+Math.cos(e.lat()*Math.PI/180)*Math.cos(t.lat()*Math.PI/180)*Math.sin(s/2)*Math.sin(s/2);return 6371*(2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)))}},{key:"addToClosestCluster_",value:function(e){for(var t,i=4e4,s=null,n=0;t=this.clusters_[n];n++){var r=t.getCenter();if(r){var o=this.distanceBetweenPoints_(r,e.getPosition());o<i&&(i=o,s=t)}}if(s&&s.isMarkerInClusterBounds(e))s.addMarker(e);else{var a=new w(this);a.addMarker(e),this.clusters_.push(a)}}},{key:"createClusters_",value:function(){if(this.ready_)for(var e,t=new google.maps.LatLngBounds(this.map_.getBounds().getSouthWest(),this.map_.getBounds().getNorthEast()),i=this.getExtendedBounds(t),s=0;e=this.markers_[s];s++)!e.isAdded&&this.isMarkerInBounds_(e,i)&&this.addToClosestCluster_(e)}}]),e}(),w=function(){function e(t){y(this,e),this.markerClusterer_=t,this.map_=t.getMap(),this.gridSize_=t.getGridSize(),this.minClusterSize_=t.getMinClusterSize(),this.averageCenter_=t.isAverageCenter(),this.center_=null,this.markers_=[],this.bounds_=null,this.clusterIcon_=new b(this,t.getStyles(),t.getGridSize())}return S(e,[{key:"isMarkerAlreadyAdded",value:function(e){if(this.markers_.indexOf)return-1!=this.markers_.indexOf(e);for(var t,i=0;t=this.markers_[i];i++)if(t==e)return!0;return!1}},{key:"addMarker",value:function(e){if(this.isMarkerAlreadyAdded(e))return!1;if(this.center_){if(this.averageCenter_){var t=this.markers_.length+1,i=(this.center_.lat()*(t-1)+e.getPosition().lat())/t,s=(this.center_.lng()*(t-1)+e.getPosition().lng())/t;this.center_=new google.maps.LatLng(i,s),this.calculateBounds_()}}else this.center_=e.getPosition(),this.calculateBounds_();e.isAdded=!0,this.markers_.push(e);var n=this.markers_.length;if(n<this.minClusterSize_&&e.getMap()!=this.map_&&e.setMap(this.map_),n==this.minClusterSize_)for(var r=0;r<n;r++)this.markers_[r].setMap(null);return n>=this.minClusterSize_&&e.setMap(null),this.updateIcon(),!0}},{key:"getMarkerClusterer",value:function(){return this.markerClusterer_}},{key:"getBounds",value:function(){for(var e,t=new google.maps.LatLngBounds(this.center_,this.center_),i=this.getMarkers(),s=0;e=i[s];s++)t.extend(e.getPosition());return t}},{key:"remove",value:function(){this.clusterIcon_.remove(),this.markers_.length=0,delete this.markers_}},{key:"getSize",value:function(){return this.markers_.length}},{key:"getMarkers",value:function(){return this.markers_}},{key:"getCenter",value:function(){return this.center_}},{key:"calculateBounds_",value:function(){var e=new google.maps.LatLngBounds(this.center_,this.center_);this.bounds_=this.markerClusterer_.getExtendedBounds(e)}},{key:"isMarkerInClusterBounds",value:function(e){return this.bounds_.contains(e.getPosition())}},{key:"getMap",value:function(){return this.map_}},{key:"updateIcon",value:function(){var e=this.map_.getZoom(),t=this.markerClusterer_.getMaxZoom();if(t&&e>t)for(var i,s=0;i=this.markers_[s];s++)i.setMap(this.map_);else if(this.markers_.length<this.minClusterSize_)this.clusterIcon_.hide();else{var n=this.markerClusterer_.getStyles().length,r=this.markerClusterer_.getCalculator()(this.markers_,n);this.clusterIcon_.setCenter(this.center_),this.clusterIcon_.setSums(r),this.clusterIcon_.show()}}}]),e}(),b=function(){function e(t,i,s){y(this,e),t.getMarkerClusterer().extend(e,google.maps.OverlayView),this.styles_=i,this.padding_=s||0,this.cluster_=t,this.center_=null,this.map_=t.getMap(),this.div_=null,this.sums_=null,this.visible_=!1,this.setMap(this.map_)}return S(e,[{key:"triggerClusterClick",value:function(){var e=this.cluster_.getBounds(),t=this.cluster_.getMarkerClusterer();google.maps.event.trigger(t.map_,"clusterclick",this.cluster_),t.isZoomOnClick()&&this.map_.fitBounds(e)}},{key:"onAdd",value:function(){if(this.div_=document.createElement("DIV"),this.visible_){var e=this.getPosFromLatLng_(this.center_);this.div_.style.cssText=this.createCss(e),this.div_.innerHTML=this.sums_.text}this.getPanes().overlayMouseTarget.appendChild(this.div_);var t=this;google.maps.event.addDomListener(this.div_,"click",(function(){t.triggerClusterClick()}))}},{key:"getPosFromLatLng_",value:function(e){var t=this.getProjection().fromLatLngToDivPixel(e);return t.x-=parseInt(this.width_/2,10),t.y-=parseInt(this.height_/2,10),t}},{key:"draw",value:function(){if(this.visible_){var e=this.getPosFromLatLng_(this.center_);this.div_.style.top=e.y+"px",this.div_.style.left=e.x+"px"}}},{key:"hide",value:function(){this.div_&&(this.div_.style.display="none"),this.visible_=!1}},{key:"show",value:function(){if(this.div_){var e=this.getPosFromLatLng_(this.center_);this.div_.style.cssText=this.createCss(e),this.div_.style.display=""}this.visible_=!0}},{key:"remove",value:function(){this.setMap(null)}},{key:"onRemove",value:function(){this.div_&&this.div_.parentNode&&(this.hide(),this.div_.parentNode.removeChild(this.div_),this.div_=null)}},{key:"setSums",value:function(e){this.sums_=e,this.text_=e.text,this.index_=e.index,this.div_&&(this.div_.innerHTML=e.text),this.useStyle()}},{key:"useStyle",value:function(){var e=Math.max(0,this.sums_.index-1);e=Math.min(this.styles_.length-1,e);var t=this.styles_[e];this.url_=t.url,this.height_=t.height,this.width_=t.width,this.textColor_=t.textColor,this.anchor_=t.anchor,this.textSize_=t.textSize,this.backgroundPosition_=t.backgroundPosition}},{key:"setCenter",value:function(e){this.center_=e}},{key:"createCss",value:function(e){var t=[];t.push("z-index:"+this.cluster_.markerClusterer_.getZIndex()+";"),t.push("background-image:url("+this.url_+");");var i=this.backgroundPosition_?this.backgroundPosition_:"0 0";t.push("background-position:"+i+";"),"object"===v(this.anchor_)?("number"==typeof this.anchor_[0]&&this.anchor_[0]>0&&this.anchor_[0]<this.height_?t.push("height:"+(this.height_-this.anchor_[0])+"px; padding-top:"+this.anchor_[0]+"px;"):t.push("height:"+this.height_+"px; line-height:"+this.height_+"px;"),"number"==typeof this.anchor_[1]&&this.anchor_[1]>0&&this.anchor_[1]<this.width_?t.push("width:"+(this.width_-this.anchor_[1])+"px; padding-left:"+this.anchor_[1]+"px;"):t.push("width:"+this.width_+"px; text-align:center;")):t.push("height:"+this.height_+"px; line-height:"+this.height_+"px; width:"+this.width_+"px; text-align:center;");var s=this.textColor_?this.textColor_:"black",n=this.textSize_?this.textSize_:11;return t.push("cursor:pointer; top:"+e.y+"px; left:"+e.x+"px; color:"+s+"; position:absolute; font-size:"+n+"px; font-family:Arial,sans-serif; font-weight:bold"),t.join("")}}]),e}(),x=T,C=i("hsyc"),M=n.a.get("StoreFinder"),L=[{textColor:"black",height:36,width:36,url:"/_ui/redesign/theme-igc/images/map_cluster.png"}],P=["exitFullscreen","webkitExitFullscreen","mozCancelFullScreen","msExitFullscreen"],E=window.matchMedia("(min-width: 992px)").matches,O=window.matchMedia("(min-width: 1200px)").matches;enquire.register("(min-width: 992px)",{match:function(){E=!0},unmatch:function(){E=!1}}).register("(min-width: 1200px)",{match:function(){O=!0},unmatch:function(){O=!1}});var B=Backbone.View.extend({initialize:function(e){this.fullscreen=!1,this.listenTo(M,"change:results",this.renderStores),this.listenTo(M,"change:results",this.panIntoStores),this.listenTo(M,"change:userLocation",this.updateUserLocationMarker),this.listenTo(M,"select-store",this.panToStore),this.initMap(e.center),this.renderStores(),this.panIntoStores(),"latitude"in M.get("userLocation")&&this.updateUserLocationMarker(M.get("userLocation"))},events:{'click .gm-control-active[title="Zoom in"], .gm-control-active[title="Zoom out"]':"zoom"},padding:{desktop:{top:0,bottom:0,right:0,left:510},mobile:{top:65,bottom:0,right:0,left:0}},is:{desktop:function(){return E},wide:function(){return O}},initMap:function(e){var t=this;this.map=new google.maps.Map(this.el,{zoom:TPS.utils.isGreatBritain()?7:9,center:e}),this.panorama=this.map.getStreetView(),this.map.fitBounds=function(e){google.maps.Map.prototype.fitBounds.call(t.map,e,t.is.desktop()?t.padding.desktop:t.padding.mobile)},google.maps.event.addListenerOnce(this.map,"tilesloaded",(function(){t.map.addListener("bounds_changed",t.onManipulation.bind(t))})),google.maps.event.addListener(this.map,"clusterclick",(function(e){M.getStores({bounds:e.getBounds().toJSON()}),google.maps.event.addListenerOnce(t.map,"idle",(function(){setTimeout((function(){return t.cluster.repaint()}))}))})),this.calcPositionOfControls(),window.addEventListener("resize",this.calcPositionOfControls.bind(this)),C.b.on("mozfullscreenchange webkitfullscreenchange fullscreenchange",(function(e){t.fullscreen=!t.fullscreen})),this.$el.removeClass("spinner")},panIntoStores:function(){var e=M.get("results").toJSON(),t=e.north,i=e.south,s=e.west,n=e.east;this.animating=!0,this.map.fitBounds({north:t,south:i,west:s,east:n})},panToStore:function(e){if(e.get("active")){var t=e.get("geoPoint");this.map.getZoom()<17&&this.map.setZoom(17);var i={lat:t.latitude,lng:t.longitude};if(this.is.desktop()&&!this.fullscreen){var s=this.map.getBounds(),n=this.el.getBoundingClientRect().width,r=(s.getNorthEast().lng()-s.getSouthWest().lng())*(this.padding.desktop.left/n)/2;i.lng-=r}this.animating=!0,this.map.panTo(i),e.view||(M.getStores({bounds:this.map.getBounds().toJSON()}),M.setActive(e))}},renderStores:function(e){var t=this;this.cluster&&this.cluster.clearMarkers();var i=[],s=M.get("results").get("stores");s.forEach((function(e){var n=new google.maps.Marker(t.getMarkerStyle(e));n.setLabel(t.getLabelStyle(s.indexOf(e)+1,e.get("formattedDistance"))),n.addListener("click",t.markerClickHandler(e)),i.push(n)})),this.cluster=new x(this.map,i,{styles:L})},markerClickHandler:function(e){var t=this;return function(){var i;if(t.fullscreen)for(var s=0;s<P.length;s++)if(P[s]in document){i=document[P[s]]();break}i?i.then((function(){M.trigger("select-store",e,!0)})):M.trigger("select-store",e,!0)}},searchActiveArea:function(){var e=this.map.getBounds(),t=this.el.getBoundingClientRect().width,i=this.is.desktop()&&!this.fullscreen?(e.getNorthEast().lng()-e.getSouthWest().lng())*(this.padding.desktop.left/t):0;(e=e.toJSON()).west+=i,M.getStores({bounds:e})},onManipulation:function(){this.animating?this.animating=!1:M.trigger("active-area-changed")},updateUserLocationMarker:function(e){this.userLocation&&this.userLocation.setMap(null),this.userAccuracy&&this.userAccuracy.setMap(null);var t=this.map,i=e.accuracy,s={lat:e.latitude,lng:e.longitude};this.userLocation=new google.maps.Marker({map:t,position:s,icon:{url:"/_ui/redesign/theme-igc/images/map-pin_user.png",scaledSize:new google.maps.Size(20,20),anchor:new google.maps.Point(10,10)},cursor:"pointer"}),this.userAccuracy=new google.maps.Circle({map:t,center:s,radius:i,fillColor:"#4187f5",fillOpacity:.2,strokeOpacity:0}),this.onManipulation()},zoom:function(e){if(this.is.desktop()&&!this.fullscreen){var t="Zoom in"===$(e.currentTarget).attr("title"),i=this.map.getBounds(),s=this.el.getBoundingClientRect().width,n=i.getSouthWest(),r=i.getNorthEast(),o=new google.maps.LatLng(n.lat(),n.lng()-(n.lng()-r.lng())*(this.padding.desktop.left/s)*(t?1:-.5)),a=new google.maps.LatLngBounds(o,r);this.map.setCenter(a.getCenter())}},calcPositionOfControls:function(){var e=$(".j-store_finder_search_area").get(0),t=google.maps.ControlPosition;this.is.desktop()?(this.map.controls[t.TOP_CENTER].length&&this.map.controls[t.TOP_CENTER].pop(),~this.map.controls[t.BOTTOM_RIGHT].indexOf(e)||this.map.controls[t.BOTTOM_RIGHT].push(e)):(this.map.controls[t.BOTTOM_RIGHT].length&&this.map.controls[t.BOTTOM_RIGHT].pop(),~this.map.controls[t.TOP_CENTER].indexOf(e)||this.map.controls[t.TOP_CENTER].push(e)),this.map.setOptions({mapTypeControl:!!this.is.desktop()||this.fullscreen,zoomControl:!!this.is.desktop()||this.fullscreen,streetViewControl:!!this.is.desktop()||this.fullscreen,mapTypeControlOptions:{position:this.is.desktop()?t.TOP_RIGHT:t.RIGHT_BOTTOM},zoomControlOptions:{position:this.is.desktop()?t.RIGHT_BOTTOM:t.RIGHT_CENTER},fullscreenControlOptions:{position:this.is.desktop()?t.TOP_RIGHT:this.fullscreen?t.RIGHT_TOP:t.RIGHT_BOTTOM},streetViewControlOptions:{position:this.is.desktop()?t.RIGHT_BOTTOM:t.RIGHT_TOP}}),this.panorama.setOptions({addressControlOptions:{position:this.is.desktop()?this.fullscreen?t.TOP_LEFT:t.TOP_RIGHT:t.TOP_LEFT}})},getMarkerStyle:function(e){return{position:{lat:e.get("geoPoint").latitude,lng:e.get("geoPoint").longitude},cursor:"pointer",icon:{labelOrigin:{x:16,y:16},url:"SUPERDRUG"===e.get("storeType")?"/_ui/redesign/theme-igc/images/map-pin_pink.png":"/_ui/redesign/theme-igc/images/map-pin_black.png"}}},getLabelStyle:function(e,t){return{color:"white",fontSize:"18px",fontFamily:'"Muli", Arial, sans-serif',text:t?"".concat(e):" "}}}),z=n.a.get("StoreFinder"),D=Backbone.View.extend({initialize:function(){var e=this;this.$search=this.$("input"),this.listenTo(z,"change:error",this.onError);var t=function(t){var i=t.query;t.searchByLocation?e.searchByLocation():(e.$search.val(i).trigger("change"),e.search())};window.addEventListener("popstate",(function(){var i=window.history.state;"storeFinder"===(null==i?void 0:i.pageComponent)?t(i):(z.setError(""),e.$search.val("").trigger("change"))}));var i=window.history.state;("storeFinder"===(null==i?void 0:i.pageComponent)&&t(i),"true"!==TPS.utils.searchQueryToObj(location.search).useLocation)?this.$search.val()&&this.search():this.searchByLocation()},events:{"keydown input":"onKeydown","click .icon_search":"search","click .j-store_finder_search_by_location":"searchByLocation"},onKeydown:function(e){13===e.keyCode&&this.search()},search:function(){var e=this.$search.blur().val();if(e){try{return JSON.parse(e),void z.setError(TPS.messages["redesign.store.finder.search.error.invalid.query"],!0)}catch(e){}_.isEqual({pageComponent:"storeFinder",query:e},window.history.state)||window.history.pushState({pageComponent:"storeFinder",query:e},null),this.searchByText(e)}},searchByText:function(e){z.setError(""),z.getStores(e)},searchByLocation:function(){var e=this;"geolocation"in navigator?navigator.geolocation.getCurrentPosition((function(t){var i=t.coords;_.isEqual({pageComponent:"storeFinder",searchByLocation:!0},window.history.state)||window.history.pushState({pageComponent:"storeFinder",searchByLocation:!0},null),e.$search.val("").trigger("change"),z.getStores(i),z.set("useLocation",!0),z.attributes.userLocation=i,z.trigger("change:userLocation",i)}),(function(e){z.setError(e.message)}),{enableHighAccuracy:!0,timeout:1e4,maximumAge:0}):z.setError("Geolocation is not available")},onError:function(){var e=z.get("error");this.$(".message_box-error").remove(),e&&this.$el.prepend('<div class="message_box message_box-error">'.concat(e,"</div>"))}}),I=n.a.get("StoreFinder"),A=Backbone.View.extend({initialize:function(){this.listenTo(I,"change:isPopular",this.togglePopularLabel),this.listenTo(I,"active-area-changed",this.toggleSearchAreaButton),this.render()},events:{"change .form_field__input":"handleChange","click .j-store_finder_search_area":"searchActiveArea"},togglePopularLabel:function(){this.$(".j-store_finder__results_label").toggle(I.get("isPopular"))},toggleSearchAreaButton:function(){this.$(".j-store_finder_search_area").css("display","")},handleChange:function(e){$(e.target).toggleClass("form_field__input-not_empty",Boolean(e.target.value))},searchActiveArea:function(){this.storeMap.searchActiveArea(),this.$(".j-store_finder_search_area").css("display","none")},render:function(){return this.renderSearch(),this.renderMap(),this.renderStores(),this},renderSearch:function(){this.search=new D({el:".j-store_finder_search",parent:this})},renderStores:function(){this.storeList=new m({el:".j-stores_list",parent:this}).render()},renderMap:function(){var e=this,t=0,i=setInterval((function(){google&&google.maps?(clearInterval(i),e.storeMap=new B({el:"#j-store_finder_map",center:e.getDefaultCoords()}).render()):t>50?(clearInterval(i),I.set("error",TPS.messages["redesign.store.details.maps.error"]),e.$("#j-store_finder_map").removeClass("spinner").addClass("loading-error").html(TPS.messages["redesign.store.details.maps.error"])):t++}),100)},getDefaultCoords:function(){return{lat:TPS.utils.isGreatBritain()?53.823423565431824:53.31870634061657,lng:TPS.utils.isGreatBritain()?-8.466084738248242:-10.894063253873242}}}),N=i("i8xx");function R(){Object(N.d)(A,{el:".j-store_finder"})}}}]);